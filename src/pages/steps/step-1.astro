---
import StepNavigation from "../../components/StepNavigation.astro";
import Layout from "../../layouts/Layout.astro";
import { zfd } from "zod-form-data";
import { ZodError, z } from "zod";
import { getDefaultValues, submitValues } from "../../cookies";
import { isHXRequest } from "../../headers";

if (Astro.request.method === "POST") {
  const schema = zfd.formData({
    name: zfd.text(),
    email: zfd.text(z.string().email()),
  });
  try {
    const formData = await Astro.request.formData();
    const formDataParsed = schema.parse(formData);
    submitValues(Astro.cookies, "step1", formDataParsed);
    if (isHXRequest(Astro.request)) {
      return Astro.redirect("/htmx/step-2", 302);
    }
    return Astro.redirect("/steps/step-2", 302);
  } catch (error) {
    if (error instanceof ZodError) {
      console.log(error);
    }
  }
}
const defaultValues = getDefaultValues(Astro.cookies, "step1");

const firstStepAvailable = !!getDefaultValues(Astro.cookies, "step1")?.name;
const secondStepAvailable = !!getDefaultValues(Astro.cookies, "step2")?.address;
const thirdStepAvailable = !!getDefaultValues(Astro.cookies, "step3")
  ?.cardNumber;

---

<Layout title="HTMX + Astro.build">
  <div id="content">
    <StepNavigation
      stepActive={1}
      firstStepAvailable={firstStepAvailable}
      secondStepAvailable={secondStepAvailable}
      thirdStepAvailable={thirdStepAvailable}
    />
    <form
      class="mt-4 p-4 border border-gray-300 rounded-lg"
      method="post"
      hx-post="/steps/step-1"
      hx-target="#content"
      hx-swap="innerHTML"
      hx-replace-url="/steps/step-2"
    >
      <label class="block mb-2">
        Name
        <input
          class=`border border-gray-300 rounded-lg p-2 w-full`
          name="name"
          value={defaultValues?.name ?? ""}
          required
        />
      </label>
      <label class="block mb-2">
        Email
        <input
          class=`border border-gray-300 rounded-lg p-2 w-full`
          type="email"
          name="email"
          value={defaultValues?.email ?? ""}
          required
        />
      </label>
      <div class="flex justify-between items-center mt-4 flex-row-reverse">
        <button
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"
          type="submit"
        >
          Next
        </button>
      </div>
    </form>
  </div>
</Layout>

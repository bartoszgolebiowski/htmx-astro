---
import Layout from "../../layouts/Layout.astro";
import { getDefaultValues, clearCookies } from "../../cookies";

const valuesFirstStep = getDefaultValues(Astro.cookies, "step1")!;
const valuesSecondStep = getDefaultValues(Astro.cookies, "step2")!;
const valuesThirdStep = getDefaultValues(Astro.cookies, "step3")!;
const firstStepAvailable = !!valuesFirstStep?.email;
const secondStepAvailable = !!valuesSecondStep?.address;
const thirdStepAvailable = !!valuesThirdStep?.cardExpiry;
const isFormFullfilled =
  firstStepAvailable && secondStepAvailable && thirdStepAvailable;

if (Astro.request.method === "POST") {
  if (isFormFullfilled) {
    clearCookies(Astro.cookies);
    return Astro.redirect("/completed", 302);
  }
}
if (!isFormFullfilled) {
  return Astro.redirect("/", 302);
}
---

<Layout title="HTMX + Astro.build">
  <a class=`border border-indigo-600 inline-block rounded-lg p-4 ` href="/steps/step-1"> First step</a>
  <pre>{JSON.stringify(valuesFirstStep,null,2)}</pre>
  <a class=`border border-indigo-600 inline-block rounded-lg p-4` href="/steps/step-2"> Second step</a>
  <pre>{JSON.stringify(valuesSecondStep,null,2)}</pre>
  <a class=`border border-indigo-600 inline-block rounded-lg p-4` href="/steps/step-3"> Third step</a>
  <pre>{JSON.stringify(valuesThirdStep,null,2)}</pre>
  <form action="/steps/summary" method="POST">
    <button
      type="submit"
      class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"
      >Submit</button
    >
  </form>
</Layout>
